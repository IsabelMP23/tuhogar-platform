---
import BaseLayout from "../../layouts/baseLayout.astro";
import PropiedadesCard from "../../components/PropiedadesCard.astro";
import SearchBar from "../../components/SearchBar.astro";
import Filter from "../../components/Filter.astro";
import { fetchPropiedades } from "../../lib/api";

const propiedades = await fetchPropiedades();

const pageSize = 10;
const url = new URL(Astro.request.url);
const page = Number(url.searchParams.get("page")) || 1;

const start = (page - 1) * pageSize;
const end = start + pageSize;

const propiedadesPagina = propiedades.slice(start, end);
const totalPaginas = Math.ceil(propiedades.length / pageSize);
---

<BaseLayout title="Propiedades">
  <main class="flex flex-col min-h-full px-3 sm:px-6 lg:px-8">
    <section class="px-6 py-10 text-white flex items-center">
      <h1 class="text-5xl">Propiedades</h1>
    </section>
    <div class="flex flex-1 flex-row gap-4 px-6 py-4">
      <Filter />
      <section class="flex-1 flex flex-col justify-between" aria-details="Resultados de búsqueda">
        <SearchBar />
        <div class="flex flex-col gap-4 flex-1">
          {
            propiedadesPagina.map((prop) => (
              <a href={`/propiedades/${prop.id_propiedad}`}>
                <PropiedadesCard prop={prop} />
              </a>
            ))
          }
        </div>
        <div class="flex justify-center mt-6 gap-4">
          {
            page > 1 && (
              <a
                href={`/propiedades?page=${page - 1}`}
                class="px-4 py-2 btn"
              >
                ← Anterior
              </a>
            )
          }

          <span class="btn">Página {page} de {totalPaginas}</span>

          {
            page < totalPaginas && (
              <a
                href={`/propiedades?page=${page + 1}`}
                class="px-4 py-2 btn"
              >
                Siguiente →
              </a>
            )
          }
        </div>
      </section>
    </div>
  </main>
</BaseLayout>
